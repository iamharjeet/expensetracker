name: Deploy to AWS ECS

on:
  push:
    branches:
      - main

env:
  DOCKER_IMAGE_NAME: iamharjeet/expensetracker
  AWS_REGION: ca-central-1
  ECS_CLUSTER: expensetracker-dev-cluster
  ECS_SERVICE: expensetracker-dev-service

jobs:
  build:
    name: Build Application
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'
      
      - name: Build with Maven
        run: mvn clean package -DskipTests
      
      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: expense-tracker-jar
          path: target/*.jar
          retention-days: 1

  docker:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: build
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: expense-tracker-jar
          path: target/
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_IMAGE_NAME }}
          tags: |
            type=sha,prefix=,format=short
            type=raw,value=latest
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE_NAME }}:latest
          cache-to: type=inline
      
      - name: Image digest
        run: echo "Image pushed with tags - ${{ steps.meta.outputs.tags }}"

  deploy:
    name: Deploy to AWS ECS
    runs-on: ubuntu-latest
    needs: docker
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Get short commit SHA
        id: sha
        run: echo "short_sha=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
      
      - name: Download task definition
        run: |
          aws ecs describe-task-definition \
            --task-definition expensetracker-dev \
            --query taskDefinition > task-definition.json
      
      - name: Update task definition with new image
        id: task-def
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: task-definition.json
          container-name: expensetracker-container
          image: ${{ env.DOCKER_IMAGE_NAME }}:${{ steps.sha.outputs.short_sha }}
      
      - name: Deploy to Amazon ECS
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: ${{ steps.task-def.outputs.task-definition }}
          service: ${{ env.ECS_SERVICE }}
          cluster: ${{ env.ECS_CLUSTER }}
          wait-for-service-stability: true
      
      - name: Deployment Summary
        run: |
          echo "‚úÖ Deployment completed successfully!"
          echo "üöÄ Image: ${{ env.DOCKER_IMAGE_NAME }}:${{ steps.sha.outputs.short_sha }}"
          echo "üì¶ Cluster: ${{ env.ECS_CLUSTER }}"
          echo "üîß Service: ${{ env.ECS_SERVICE }}"
          echo "üåç Region: ${{ env.AWS_REGION }}"
          echo ""
          echo "To view your application:"
          echo "1. Go to AWS Console ‚Üí ECS ‚Üí Clusters ‚Üí ${{ env.ECS_CLUSTER }}"
          echo "2. Click on the service ‚Üí Tasks tab"
          echo "3. Find the public IP of the running task"
